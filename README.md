Техническая документация проекта Telegram Case Bot

1. Введение

1.1 Описание проекта

Telegram Case Bot — бот в Telegram для загрузки политических кейсов в формате PDF, анализа через Google Gemini API и возвращения рекомендаций пользователю.

1.2 Основные функции

- Интерфейс с кнопками: Удобное взаимодействие с пользователем через настраиваемые кнопки и автоматические уведомления.
- Пользовательское соглашение: Пользователь обязан принять соглашение перед загрузкой файлов.
- Загрузка PDF-файлов: Возможность загружать политические кейсы в формате PDF для анализа.
- Анализ данных: Обработка загруженного текста с помощью Google Gemini API для выявления несоответствий и формирования рекомендаций.
- Создание отчетов: Генерация PDF-отчетов с результатами анализа для отправки пользователю.
- Обработка ошибок и уведомления: Уведомление пользователя об ошибках и предоставление опции связи с поддержкой.
- Логирование: Запись всех событий и ошибок для последующего анализа и диагностики.

2. Архитектура проекта (Актуальная)

telegram_case_bot/
│
├── bot.py                     # Основной файл запуска бота и логика взаимодействия
├── config.py                  # Конфигурации и ключи API (включая Gemini API Key)
├── report_generator.py        # Генерация отчета в формате PDF
│
├── utils/                     # Вспомогательные модули
│   ├── gemini_client.py       # Модуль для связи с Google Gemini API
│   ├── logger.py              # Настройка и управление логированием
│   ├── pdf_processor.py       # Модуль для обработки и извлечения текста из PDF
│   └── errors.py              # Базовый класс для кастомных ошибок
│
├── handlers/                  # Обработчики Telegram событий
│   └── document_handler.py    # Логика обработки загруженных документов
│
├── exceptions/                # Кастомные классы исключений
│   ├── __init__.py
│   ├── gemini_api_error.py
│   └── pdf_processing_error.py
│
├── data/
│   ├── templates/             # Шаблоны для PDF-отчета (если используются)
│   └── generated_reports/     # Директория для временно сохраняемых отчетов (если требуется)
│
├── logs/                      # Папка для логов ошибок и событий
│
├── tests/                     # Папка для тестов
│   ├── __init__.py
│   ├── test_report_generator.py # Тесты для генерации отчетов
│   └── utils/
│       ├── __init__.py
│       ├── test_pdf_processor.py  # Тесты для обработки PDF
│       └── test_gemini_client.py  # Тесты для Google Gemini API
│
├── requirements.txt           # Основные зависимости проекта
├── dev-requirements.txt       # Зависимости для разработки и тестирования
├── .env.example               # Пример файла переменных окружения
├── .gitignore
└── LICENSE

2.1 Обзор документации (Обновленный)

Telegram Case Bot — это бот для анализа политических кейсов в формате PDF. Пользователи загружают документ в бот, который обрабатывает текст через Google Gemini API и предоставляет рекомендации.

#### Основные функции (без изменений)
1. **Интерфейс**: Взаимодействие через настраиваемые кнопки.
2. **Загрузка и анализ PDF**: Пользователь загружает PDF, текст анализируется, и на выходе создается отчет.
3. **Ошибки и уведомления**: Бот уведомляет о сбоях и предоставляет возможность обратиться в поддержку.
4. **Логирование**: Ведение логов событий для диагностики и улучшения.

#### Структура проекта (Обновленная)
Основные файлы и директории:
- **bot.py** — основная логика работы бота, управление диалогами.
- **config.py** — файл с конфигурацией (токены Telegram, Gemini API ключ).
- **utils/pdf_processor.py** — извлечение текста и первичная обработка PDF.
- **utils/gemini_client.py** — отправка данных в Google Gemini API и получение ответа.
- **report_generator.py** — создание PDF-отчета.
- **handlers/document_handler.py** — координация процесса обработки документа.
- **utils/logger.py** — настройка логирования.
- **logs/** — хранение логов.
- **tests/** — юнит-тесты для проверки модулей.

#### Используемые технологии (Обновленные)
- **Python 3.10+** — основной язык программирования.
- **Ключевые библиотеки**:
    - `python-telegram-bot` — взаимодействие с Telegram API.
    - `google-generativeai` — для анализа текста с помощью Gemini API.
    - `pdfplumber` — извлечение текста из PDF.
    - `reportlab` — генерация отчетов.
    - `python-dotenv` — управление переменными окружения.
    - `langdetect` — определение языка текста.

#### Установка и настройка (Обновленные)
1. Установить Python 3.10 или выше.
2. Клонировать репозиторий.
3. Создать и активировать виртуальное окружение: `python -m venv venv && source venv/bin/activate` (или `venv\Scripts\activate` для Windows).
4. Установить зависимости: `pip install -r requirements.txt`. Для разработки также: `pip install -r dev-requirements.txt`.
5. Скопировать `.env.example` в `.env` (`cp .env.example .env`).
6. Заполнить `.env` актуальными значениями: `TELEGRAM_BOT_TOKEN` и `GEMINI_API_KEY`.
7. Запустить бота: `python bot.py`.

#### Безопасность (Обновленная)
- **API Ключи**: Конфиденциальные ключи (Telegram, Gemini) хранятся в файле `.env` и не должны попадать в систему контроля версий.
- **Передача данных**: Взаимодействие с Gemini API происходит по HTTPS, обеспечиваемому клиентской библиотекой `google-generativeai`. Клиентское AES шифрование удалено, так как оно было специфично для предыдущей реализации.
- **Логирование**: Записываются только технические данные, чтобы защитить конфиденциальность пользователей. Содержимое документов и личные данные не логируются.

#### Тестирование (Обновленное)
Рекомендуется использовать `pytest` для юнит-тестов.
- Запуск тестов: `pytest tests/`
- Отчет о покрытии: `coverage run -m pytest && coverage report` (или `coverage html` для HTML отчета).
Тесты покрывают ключевые функции, такие как обработка PDF (`utils/test_pdf_processor.py`), взаимодействие с Gemini API (`utils/test_gemini_client.py`), и генерация отчетов (`test_report_generator.py`).

(Разделы 2.1 - 2.4 из старого README были очень подробными и специфичными для OpenAI. Они будут заменены более общим описанием ниже)

2.2 Общая структура модулей (Обновленная)

- **`bot.py`**: Основной модуль, отвечающий за взаимодействие с Telegram API. Реализует логику пользовательского интерфейса (включая пользовательское соглашение через `ConversationHandler`), получение PDF-файлов и делегирование их обработки модулю `handlers.document_handler`.
- **`config.py`**: Файл конфигурации, использующий `python-dotenv` для загрузки переменных окружения (`TELEGRAM_BOT_TOKEN`, `GEMINI_API_KEY`, настройки логирования, параметры обработки PDF).
- **`handlers/document_handler.py`**: Оркестрирует процесс обработки одного PDF-документа. Вызывает `pdf_processor` для извлечения текста, затем `gemini_client` для анализа, и наконец `report_generator` для создания PDF-отчета. Управляет уведомлениями пользователя о ходе процесса и ошибках.
- **`utils/pdf_processor.py`**: Содержит функции для обработки загруженных PDF-файлов (извлечение текста с `pdfplumber`, проверка на минимальную длину текста, определение языка с `langdetect`).
- **`utils/gemini_client.py`**: Модуль для формирования и отправки запросов к Google Gemini API с использованием библиотеки `google-generativeai`. Обрабатывает ответы от Gemini и подготавливает их для использования в генераторе отчетов.
- **`report_generator.py`**: Создает PDF-отчеты для пользователей на основе данных, полученных от Gemini. Использует библиотеку `reportlab`.
- **`utils/logger.py`**: Конфигурирует логирование для записи технических ошибок и событий в лог-файлы (например, `logs/bot_errors.log`) и в консоль.
- **`exceptions/`**: Содержит кастомные классы исключений (`GeminiAPIError`, `PDFProcessingError`) для лучшей обработки ошибок.

2.3 Поток взаимодействия (Обновленный)

1.  Пользователь инициирует диалог с ботом (например, командой `/start`).
2.  Бот предлагает принять пользовательское соглашение.
3.  После принятия соглашения пользователь загружает PDF-файл.
4.  `bot.py` передает управление `handlers.document_handler.py`.
5.  `document_handler` вызывает `utils.pdf_processor.py` для извлечения и предварительной проверки текста.
6.  Если текст валиден, `document_handler` вызывает `utils.gemini_client.py` для отправки текста на анализ в Google Gemini API.
7.  После получения результатов от Gemini, `document_handler` вызывает `report_generator.py` для создания PDF-отчета.
8.  `document_handler` отправляет сгенерированный PDF-отчет пользователю.
9.  В случае ошибок на любом этапе, пользователь уведомляется, и ошибка логируется.

(Раздел 3 "Используемые технологии" уже обновлен в п. 2.1)
(Раздел 3.4.1 "Проблемы с библиотеками" - общий, можно оставить или убрать для краткости. Пока уберу.)
(Раздел 3.5 "Влияние на работоспособность системы" - заменить OpenAI на Gemini)

3. Влияние внешних API на работоспособность

- **Google Gemini API**: Зависимость от Gemini API может привести к сбоям в работе бота при недоступности сервиса, изменениях в API или превышении лимитов запросов. Важно предусмотреть механизмы для обработки ошибок API (реализовано в `GeminiAPIError` и `gemini_client`), включая информирование пользователя.

(Раздел 4 "Установка и настройка" уже обновлен в п. 2.1)
(Раздел 5 "Безопасность" уже обновлен в п. 2.1)

(Раздел 6 "Обработка ошибок и уведомления" - основной текст остается актуальным, но специфичные упоминания OpenAI API нужно заменить)

6. Обработка ошибок и уведомления

6.1 Логирование ошибок
   - Конфигурация логирования: В модуле `utils.logger.py` настроено логирование.
   - Содержание логов: Техническая информация, коды ошибок, статусы, идентификаторы запросов.

6.2 Уведомления об ошибках
   - Информирование пользователей: При ошибках бот уведомляет пользователя.
   - Связь с поддержкой: Предоставляется опция связи с поддержкой.

6.3 Логирование запросов и уведомления об ошибках API
   - Каждое обращение к Google Gemini API и его результат логируются.
   - При проблемах с Gemini API (например, превышение лимитов), бот уведомляет пользователя. Шаблоны уведомлений находятся в `handlers/document_handler.py`.

(Раздел 6.4 "Шаблоны расширенных уведомлений" - эти шаблоны реализованы в `document_handler.py` и в целом актуальны, просто заменить OpenAI на Gemini где нужно в описании)

(Раздел 7 "Генерация отчетов" - актуализировать упоминание API)

7. Генерация отчетов

7.1 Структура PDF-отчета
   - Состав отчета: Отчет из `report_generator.py` включает результаты анализа от Google Gemini API (введение, результаты анализа, рекомендации, заключение).
   - Структура и оформление: Используется `reportlab`.

(Раздел 8 "Поддержка и отладка" - актуализировать ошибки API)

8.1 Частые ошибки
   - Ошибка загрузки PDF-файла: Неверный формат, превышение размера.
   - Ошибка извлечения текста из PDF: Нестандартный формат, зашифрованный файл, нет текстового слоя.
   - Ошибка взаимодействия с Google Gemini API: Проблемы с API-ключом, лимиты, недоступность сервиса.
   - Ошибка генерации PDF-отчета: Некорректные данные от Gemini, проблемы с `reportlab`.
   - Ошибка логирования: Папка `/logs` недоступна.

(Раздел 9 "Тестирование" уже обновлен в п. 2.1)
(Раздел 10 "Мониторинг и аналитика" - заменить упоминания API)

10. Мониторинг и аналитика

10.1 Система мониторинга
   - Sentry: Для отслеживания ошибок.
   - Prometheus и Grafana: Для сбора и визуализации метрик (количество запросов, время отклика, статистика ошибок по модулям, включая `gemini_client`).

(Раздел 11 "Обработка конфиденциальных данных" - убрать специфичное упоминание шифрования для OpenAI, так как Gemini клиент это обрабатывает)

11. Обработка конфиденциальных данных

11.1 Политика хранения данных
   - Временное хранение PDF-файлов до завершения обработки, затем удаление.
   - Временные данные обработки также удаляются.

11.2 Защита конфиденциальности пользователей
   - API ключи в `.env`.
   - Взаимодействие с Gemini API по HTTPS.
   - Анонимизация данных при сборе метрик.

(Раздел 12 "Примеры и инструкции для разработчиков" - заменить OpenAI на Gemini)

12. Примеры и инструкции для разработчиков

12.1 Пример API-запросов к Google Gemini

Модуль `utils.gemini_client.py` содержит функцию `analyze_text_with_gemini`. Пример использования:

```python
# Внутри вашего кода, после настройки API ключа
# from utils.gemini_client import analyze_text_with_gemini
# from exceptions import GeminiAPIError
#
# try:
#     text_to_analyze = "Полный текст вашего политического кейса..."
#     # Модель можно указать, по умолчанию используется gemini-pro или аналогичный
#     analysis_result = analyze_text_with_gemini(text_to_analyze)
#     print(analysis_result)
# except GeminiAPIError as e:
#     print(f"Ошибка Gemini API: {e}")
```
Конкретные параметры запроса (например, `model_name`) и обработка ответа реализованы в `utils.gemini_client.py`. Gemini API возвращает структурированный ответ, который парсится для получения текстового результата.

12.2 Пример структуры сообщений для пользователей
   - Реализованы в `handlers/document_handler.py` и `bot.py`. Примеры: приветствие, запрос соглашения, уведомления о прогрессе и ошибках.

12.3 Примеры для деплоя и CI/CD
   - Пример CI/CD с GitHub Actions (обновить `OPENAI_API_KEY` на `GEMINI_API_KEY` в `env` секции для deploy job).
   - Минимальные требования для сервера (ОС, Python, RAM, SSL/TLS, systemd/Docker).
   - Пример systemd сервиса.

Файл `.github/workflows/deploy.yml` (пример):
```yaml
name: Telegram Case Bot CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3 # Updated version
    - name: Set up Python
      uses: actions/setup-python@v4 # Updated version
      with:
        python-version: '3.10' # Или версия, указанная в проекте
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r dev-requirements.txt # Install dev deps for testing
    - name: Run Tests
      run: pytest tests/

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install dependencies # Optional if server has them cached or handles differently
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Deploy to Server
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # Updated to GEMINI_API_KEY
      run: |
        # Пример команды для деплоя, адаптируйте под свой сервер и способ деплоя
        # ssh user@yourserver 'cd /path/to/telegram_case_bot && git pull && systemctl --user restart telegram_case_bot.service'
        echo "Deploy step needs to be configured for your server."
```

12.4 Локальное тестирование и разработка
   - Настройка виртуального окружения.
   - Установка зависимостей из `requirements.txt` и `dev-requirements.txt`.
   - Создание и заполнение `.env` файла (из `.env.example`) ключами `TELEGRAM_BOT_TOKEN` и `GEMINI_API_KEY`.
   - Для локального тестирования `gemini_client` без реальных API вызовов, используйте мокинг, как показано в `tests/utils/test_gemini_client.py`.
