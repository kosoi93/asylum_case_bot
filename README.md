 Техническая документация проекта Telegram Case Bot

1. Введение

1.1 Описание проекта

Telegram Case Bot — бот в Telegram для загрузки политических кейсов в формате PDF, анализа через OpenAI и возвращения рекомендаций пользователю.

1.2 Основные функции

	•	Интерфейс с кнопками: Использование кнопок для удобного взаимодействия с ботом.
	•	Пользовательское соглашение: Обязательное согласие перед загрузкой кейсов.
	•	Загрузка кейсов: Поддержка загрузки PDF-файлов с политическими кейсами.
	•	Анализ кейсов: Использование OpenAI API для анализа и выявления несостыковок в кейсах.
	•	Генерация отчетов: Создание PDF-отчетов с результатами анализа.
	•	Ошибки и уведомления: Обработка и уведомление об ошибках, включая опцию связи с поддержкой.
	•	Логирование: Логирование технических ошибок и процессов для отслеживания состояния бота.

2. Архитектура проекта

telegram_case_bot/
│
├── bot.py                     # Основной файл запуска бота и логика взаимодействия с пользователями
├── config.py                  # Конфигурации и ключи API
├── pdf_processing.py          # Модуль для обработки и извлечения текста из PDF
├── openai_api.py              # Модуль для связи с OpenAI API
├── report_generator.py        # Генерация отчета в формате PDF
├── logging_config.py          # Настройка логирования для технических ошибок
│
├── data/
│   └── templates/             # Шаблоны для PDF-отчета (если нужно)
│
└── logs/                      # Папка для логов ошибок и технических данных

2.1 Общая структура

bot.py
Основной модуль, отвечающий за взаимодействие с Telegram API. Реализует логику пользовательского интерфейса, включая кнопки, получение PDF-файлов от пользователей и отправку уведомлений об ошибках. Взаимодействует с модулями для обработки PDF-документов, работы с OpenAI API, генерации отчетов и логирования событий и ошибок.

config.py
Файл конфигурации, в котором хранятся токены и ключи API, такие как Telegram Bot Token, OpenAI API Key и параметры для шифрования. Обеспечивает доступ к данным конфигурации для всех модулей.

pdf_processing.py
Содержит функции для обработки загруженных PDF-файлов, включая извлечение текста для дальнейшего анализа. Использует библиотеки, такие как PyMuPDF или pdfplumber, для обработки PDF-документов.

openai_api.py
Модуль для формирования и отправки запросов к OpenAI API. Обрабатывает ответы от OpenAI и подготавливает их для использования в других модулях, таких как генерация отчетов.

report_generator.py
Создает PDF-отчеты для пользователей на основе данных, полученных от OpenAI. Использует библиотеку reportlab для генерации PDF-документов.

logging_config.py
Конфигурирует логирование, чтобы сохранять технические ошибки и события в лог-файлы без конфиденциальных данных. Настроено на запись логов в файл logs/bot_errors.log, что упрощает отслеживание ошибок.

data/templates/
Папка для хранения шаблонов и данных, необходимых для создания отчетов в формате PDF, если требуется специфическое форматирование.

logs/
Папка для хранения логов технических ошибок и событий, что позволяет удобно управлять и анализировать журналы.

2.2 Основные модули

	•	bot.py: Основной файл, управляющий логикой бота и взаимодействием с пользователем.
	•	pdf_processing.py: Модуль для обработки PDF-файлов и извлечения текста.
	•	openai_api.py: Модуль для обращения к API OpenAI.
	•	report_generator.py: Модуль для генерации отчетов в формате PDF.
	•	logging_config.py: Настройка и конфигурация логирования ошибок и технических событий.

2.3 Поток взаимодействия

	1.	Пользователь принимает соглашение.
	2.	Загружает PDF-файл.
	3.	Бот обрабатывает PDF-файл с помощью Pdfplumber, шифрует данные и отправляет текст в OpenAI.
	4.	Бот получает результаты, создаёт отчет (PDF) с помощью reportlab и отправляет пользователю.
	5.	В случае ошибки — уведомление пользователю и владельцу и логирование для владельца.

Раздел 2.4: Поток обработки данных и запросов

	•	Инициализация и безопасное соединение
Бот запускается с использованием python-telegram-bot, обеспечивая взаимодействие с Telegram API через SSL/TLS. Это защищает передаваемые данные от перехвата.
	•	Загрузка и обработка PDF-файла
После загрузки пользователем PDF-файла бот использует pdf_processing.py и библиотеку Pdfplumber для извлечения текста, который затем подготавливается для отправки в OpenAI.
	•	Шифрование данных
Данные шифруются с помощью библиотеки cryptography, чтобы сохранить конфиденциальность на этапе передачи.
	•	Запрос к OpenAI и обработка ответа
Отправка текста в OpenAI происходит через openai_api.py. Запрос включает параметры, такие как используемая модель, ограничение на длину ответа и другие настройки. Бот получает и обрабатывает ответ для подготовки отчета.
	•	Генерация отчета
Бот использует report_generator.py и reportlab для создания PDF-отчета на основе данных OpenAI. Отчет содержит основные выводы и рекомендации.
	•	Логирование взаимодействий и событий
На каждом этапе выполнения операций ведется логирование через logging_config.py. Логи сохраняются в /logs, что облегчает диагностику ошибок и анализ работы бота.


3. Используемые технологии




3.1 Язык программирования

	•	Python 3.10

3.2 Библиотеки и зависимости

• python-telegram-bot: Взаимодействие с Telegram API с использованием защищенного соединения SSL/TLS для безопасного обмена данными.
• openai: Подключение к OpenAI API, настройка параметров запросов (модель, длина ответа) для анализа текста.
• Pdfplumber: Извлечение текста из PDF-файлов, поддержка крупномасштабной обработки текстовых данных из файлов.
• reportlab: Генерация PDF-отчетов с возможностью настройки визуальных элементов и структуры отчета.
• cryptography: Шифрование данных перед отправкой в OpenAI, поддержка AES для повышения безопасности передачи.
• logging: Стандартное логирование в Python для сохранения информации о событиях, ошибках и отладке.


3.3 Среда развертывания

	•	SSL/TLS для защиты данных.

4. Установка и настройка

4.1 Требования

	•	Python 3.10
	•	Аккаунт и API ключи для Telegram и OpenAI

4.2 Конфигурация

Для корректной работы Telegram Case Bot требуется настроить файл config.py, в котором будут храниться все необходимые параметры конфигурации. Файл config.py содержит ключи API, настройки шифрования и другие параметры, необходимые для работы бота. Описание основных конфигураций:

	•	TELEGRAM_BOT_TOKEN: Токен, полученный при создании бота в Telegram. Этот токен позволяет боту подключаться к Telegram API и обрабатывать сообщения пользователей.
	•	OPENAI_API_KEY: Ключ API для доступа к OpenAI. Он используется для отправки запросов на анализ данных, извлечённых из загруженных PDF-файлов, и получения ответов от модели.
	•	ENCRYPTION_KEY: Ключ для шифрования данных перед передачей в OpenAI API. Для этого используется библиотека cryptography. Ключ шифрования обеспечивает безопасность конфиденциальных данных при их обработке.
	•	LOGGING_LEVEL: Уровень логирования, который задаёт уровень детализации информации, записываемой в лог-файлы. Возможные уровни включают DEBUG, INFO, WARNING, ERROR, и CRITICAL. Рекомендуется устанавливать INFO для рабочих версий и DEBUG для отладки.
	•	PDF_PROCESSING_SETTINGS: Параметры для модуля обработки PDF-файлов. Могут включать настройки по размерам загружаемых файлов, форматам, и методам извлечения текста.
	•	REPORT_TEMPLATE_PATH: Путь к шаблону отчета в формате PDF, который будет использоваться для создания отчетов. Этот параметр позволяет указать конкретный шаблон для улучшения унификации отчетов.

Файл config.py должен быть защищён и не должен быть доступен для посторонних, так как содержит конфиденциальные данные, включая API-ключи.

5. Безопасность

5.1 Шифрование данных

	•	Шифрование перед отправкой в OpenAI: Перед отправкой данных из загруженных PDF-файлов в OpenAI API бот шифрует их с использованием алгоритма AES-256 (Advanced Encryption Standard) из библиотеки cryptography. Этот метод обеспечивает высокий уровень безопасности, защищая данные от перехвата и несанкционированного доступа во время передачи.
	•	Хранение ключей шифрования: Ключ шифрования (ENCRYPTION_KEY) хранится в конфигурационном файле config.py, доступ к которому ограничен. В целях повышения безопасности рекомендуется использовать переменные окружения для хранения ключей шифрования, чтобы избежать их прямого хранения в коде.

5.2 Логирование без конфиденциальной информации

	•	Ограничение логируемых данных: Для защиты конфиденциальности данные, которые бот записывает в логи, не содержат чувствительной информации, такой как личные данные пользователей или содержимое загруженных документов. Логирование ограничено технической информацией: коды ошибок, статусы выполнения задач, временные метки и идентификаторы запросов. Это позволяет администратору отслеживать состояние работы бота и диагностировать ошибки без компрометации данных пользователей.
	•	Защита логов: Лог-файлы хранятся в папке /logs с доступом только для администратора системы. Это ограничивает риск несанкционированного доступа к логам и снижает вероятность утечек данных. Файлы логов автоматически архивируются и удаляются через определённый период, чтобы предотвратить накопление данных и минимизировать возможные риски.

6. Обработка ошибок и уведомления

6.1 Логирование ошибок

	•	Конфигурация логирования: В модуле logging_config.py настроено логирование всех ошибок и событий, связанных с работой бота. Логи сохраняются в файлах в папке /logs, что позволяет администратору отслеживать и анализировать ошибки и поведение бота.
	•	Содержание логов: Логи содержат следующую информацию:
	•	Коды ошибок и описание возникающих исключений.
	•	Временные метки, идентификаторы запросов и статусы задач для быстрого поиска проблем.
	•	Ключевые технические данные, исключая конфиденциальную информацию, что помогает отслеживать состояние бота, не нарушая конфиденциальность данных пользователей.

6.2 Уведомления об ошибках

	•	Информирование пользователей: В случае возникновения ошибок бот уведомляет пользователя с помощью заранее настроенного сообщения. Это сообщение включает описание проблемы и рекомендации по дальнейшим действиям.
	•	Процедура связи с поддержкой: Если ошибка не решается автоматически, пользователю предлагается связаться с технической поддержкой. Для этого бот предоставляет информацию о возможных способах связи (например, адрес электронной почты или ссылку на контактный центр), что помогает пользователю оперативно получить помощь.

6.3 Логирование запросов и уведомления об ошибках

	•	Логирование запросов к OpenAI API: Каждое обращение к OpenAI API и его результат записываются в логи. Это помогает отследить частоту и успешность запросов, а также диагностировать ошибки, связанные с интеграцией API.
	•	Уведомление об ошибках API: В случае проблем при обращении к OpenAI API, таких как превышение лимитов запросов, бот немедленно отправляет уведомление пользователю с объяснением причины задержки. Ошибка также записывается в лог для дальнейшего анализа, чтобы администратор мог быстро предпринять необходимые меры для восстановления работоспособности.

7. Генерация отчетов

7.1 Структура PDF-отчета

	•	Состав отчета: Отчет, создаваемый с помощью модуля report_generator.py, включает результаты анализа, выполненного с помощью OpenAI API. Основные разделы отчета:
	•	Введение: Краткое описание загруженного кейса, включая дату анализа и основные параметры.
	•	Результаты анализа: Основные выводы и выявленные несоответствия в политическом кейсе, если таковые имеются. Данный раздел формируется на основе ответов, полученных от OpenAI.
	•	Рекомендации: Персонализированные рекомендации, подготовленные для пользователя в зависимости от анализа текста.
	•	Заключение: Резюме ключевых моментов и, при необходимости, дальнейшие действия.
	•	Структура и оформление: Используется библиотека reportlab, которая позволяет гибко настраивать визуальные элементы отчета, такие как:
	•	Заголовки и подзаголовки для четкой структуризации.
	•	Таблицы и списки для представления данных в удобной для восприятия форме.
	•	Логотип или другие элементы оформления для улучшения визуальной привлекательности (по мере необходимости).

7.2 Пример содержания отчета

	•	Описание примера: Пример отчета включает следующие разделы:
	•	Титульная страница: Название отчета, информация о пользователе, дата и уникальный идентификатор отчета.
	•	Результаты анализа: Например, «В загруженном кейсе выявлено несколько ключевых несостыковок, таких как…». Здесь выводы сформулированы в краткой и понятной форме.
	•	Рекомендации: Конкретные советы или дальнейшие шаги, такие как «Рекомендуется более подробно исследовать такие аспекты, как…».
	•	Заключение: Резюмирующее высказывание с основными выводами и, при необходимости, предложением на дальнейшее сотрудничество или обращение к дополнительной поддержке.
	•	Шаблоны для отчета: Хранятся в папке data/templates/

8. Поддержка и отладка

8.1 Частые ошибки

	•	Ошибка загрузки PDF-файла
	•	Описание: Ошибка может возникнуть, если загружаемый файл не соответствует требуемому формату или превышает допустимый размер.
	•	Метод устранения: Убедитесь, что загружаемый файл — это PDF и его размер не превышает установленный лимит. В противном случае бот отправит пользователю уведомление с информацией о допустимых параметрах загрузки.
	•	Ошибка извлечения текста из PDF
	•	Описание: Возникает при обработке PDF-файлов, если файл имеет нестандартное форматирование или зашифрован.
	•	Метод устранения: Проверьте формат файла и убедитесь, что он не защищен паролем. Модуль pdf_processing.py поддерживает только текстовые PDF. Если проблема сохраняется, рекомендуется преобразовать документ в стандартный PDF с текстовым слоем.
	•	Ошибка взаимодействия с OpenAI API
	•	Описание: Может возникнуть из-за проблем с API-ключом, превышения лимитов запросов или временной недоступности OpenAI API.
	•	Метод устранения: Проверьте действительность API-ключа в config.py и убедитесь, что он не превысил установленный лимит запросов. Если проблема связана с перегрузкой сервера OpenAI, попробуйте повторить запрос позже.
	•	Ошибка генерации PDF-отчета
	•	Описание: Ошибка возникает при формировании PDF-отчета, если в ответе от OpenAI содержатся некорректные данные или данные не соответствуют шаблону.
	•	Метод устранения: Проверить корректность данных, возвращаемых от OpenAI, и отладить шаблон в report_generator.py. В случае обнаружения ошибки бот уведомляет пользователя о невозможности сформировать отчет.
	•	Ошибка логирования
	•	Описание: Ошибка может возникнуть при записи логов, если папка /logs недоступна или отсутствует.
	•	Метод устранения: Убедитесь, что папка /logs существует и имеет правильные разрешения на запись. При необходимости создайте папку вручную или настройте путь для логирования в logging_config.py.

8.2 Контакты для поддержки

	•	Электронная почта: Пользователи могут отправлять сообщения с описанием проблемы на адрес технической поддержки, например, support@example.com.
	•	Telegram-канал или чат поддержки: В случае возникновения вопросов или технических проблем пользователи могут обратиться в специальный канал или чат поддержки в Telegram. Информация о канале указана в меню бота или доступна при возникновении ошибки.
	•	Дополнительные ресурсы: В случае распространенных проблем бот может автоматически предоставить пользователю ссылки на FAQ или инструкции по устранению неполадок.

9. Лицензия

Описание лицензии, если проект доступен публично.

Этот шаблон охватывает все ключевые аспекты проекта, которые легко дополнить в других чатах. Удачи в разработке!
